<!DOCTYPE html>
<head>
	<title>Prime-numbers test alasql.js database</title>
	<script src="../lib/sql-parser/sql-parser.js"></script>
	<script src="../src/alasql.js"></script>

	<style>
		td, th {
			border: 1px solid black;
		}
	</style>

</head>
<body>
	<h1>Test of alasql.js database: OLAP-cube</h1>
	<div id="result"></div>
	<script>
		var db = new alasql.Database();
		db.exec('CREATE TABLE orders (ordnum INT, clientid STRING, orddate DATE)');
		db.exec('CREATE TABLE orderlines (ordnum INT, productid INT, price MONEY, qty INT)');
		db.exec('CREATE TABLE clients (clientid STRING PRIMARY KEY, clientname STRING, regionid STRING)');


		db.tables.orders.recs.push({ordnum:1, clientid: 'ABC', orddate: new Date(2014,0,1)});
		db.tables.orderlines.recs.push({ordnum:1, productid: 1001, price:11, qty:5});
		db.tables.orderlines.recs.push({ordnum:1, productid: 1002, price:21, qty:10});
		db.tables.orderlines.recs.push({ordnum:1, productid: 1003, price:31, qty:20});
		db.tables.orderlines.recs.push({ordnum:1, productid: 1004, price:41, qty:30});

		db.tables.orders.recs.push({ordnum:2, clientid: 'KLM', orddate: new Date(2013,11,1)});
		db.tables.orderlines.recs.push({ordnum:2, productid: 1001, price:12, qty:5});
		db.tables.orderlines.recs.push({ordnum:2, productid: 1002, price:22, qty:10});
		db.tables.orderlines.recs.push({ordnum:2, productid: 1003, price:32, qty:20});

		db.tables.orders.recs.push({ordnum:3, clientid: 'XYZ', orddate: new Date(2014,1,2)});
		db.tables.orderlines.recs.push({ordnum:3, productid: 1001, price:13, qty:15});
		db.tables.orderlines.recs.push({ordnum:3, productid: 1002, price:23, qty:20});
		db.tables.orderlines.recs.push({ordnum:3, productid: 1003, price:33, qty:30});

		db.tables.orders.recs.push({ordnum:4, clientid: 'XYZ', orddate: new Date(2014,2,2)});
		db.tables.orderlines.recs.push({ordnum:4, productid: 1001, price:14, qty:15});
		db.tables.orderlines.recs.push({ordnum:4, productid: 1002, price:24, qty:20});

		db.tables.orders.recs.push({ordnum:5, clientid: 'XYZ', orddate: new Date(2014,0,1)});
		db.tables.orderlines.recs.push({ordnum:5, productid: 1001, price:34, qty:15});
		db.tables.orderlines.recs.push({ordnum:5, productid: 1002, price:4, qty:10});

		db.tables.clients.recs.push({clientid: 'ABC', clientname: 'ABC Corporation', regionid: 'East'});
		db.tables.clients.recs.push({clientid: 'KLM', clientname: 'KLM Airlines', regionid: 'East'});
		db.tables.clients.recs.push({clientid: 'XYZ', clientname: 'XYZ Incorporated', regionid: 'South'});


		var cube = {
			sql: ' SELECT orders.*, orderlines.productid, orderlines.qty, clients.regionid '+
				' FROM orders '+
				' LEFT JOIN orderlines ON orders.ordnum = orderlines.ordnum '+
				' LEFT JOIN clients ON orders.clientid = clients.clientid '
		};

		var mdx = {
 			mdxwherefn: function(rec){return rec.productid==1001 || rec.productid==1002 },
			mdxselectfn: function (scope, rec){ 
				rec.amt = scope.orderlines.price * rec.qty; 
				rec.monid = +scope.orders.orddate.toLocaleDateString().substr(3,2); 
				rec.yearid = +scope.orders.orddate.toLocaleDateString().substr(6,4); 
			},
			mdxgroupfn: function(rec){
				var group = this.groups[this.addressfn(rec)];
				if(!group) {
					group = this.groups[this.addressfn(rec)] = {
						clientid: rec.clientid,
						productid: rec.productid,
						yearid: rec.yearid,
						monid: rec.monid,
						amt: 0,
						qty: 0,
					};
				}
				group.amt += rec.amt; 
				group.qty += rec.qty;
			},
			addressfn: function(rec){return rec.clientid+'`'+rec.productid+'`'+rec.yearid+'`'+rec.monid}
		};

		// STEP 1

		var query = db.compileQuery(cube.sql);
		query.mdxwherefn = mdx.mdxwherefn;
		query.mdxselectfn = mdx.mdxselectfn;
		query.groupfn = mdx.mdxgroupfn;
		query.addressfn = mdx.addressfn; // Можно добавить в основной текст

//		console.log(query);
//		var res = db.exec(cube.sql);
		cube.recs = query.exec(db);
		cube.xrecs = {};
		cube.recs.forEach(function(rec){cube.xrecs[mdx.addressfn(rec)] = rec;});

		// STEP 2

		var clientDim = {
			fldids: ['clientid'],
			addressfn: function(rec){return rec.clientid},
			namefn: function(rec){ return rec.clientid},
			sortfn: undefined
		};

		var productDim = {
			fldids: ['productid'],
			addressfn: function(rec){return rec.productid},
			namefn: function(rec){ return rec.productid},
			sortfn: undefined
		};

		var yearMonDim = {
			fldids: ['yearid', 'monid'],
			addressfn: function(rec){return rec.yearid+'`'+rec.monid},
			namefn: function(rec){
				return [
					'January',
					'February',
					'March',
					'April',
					'May',
					'June',
					'July',
					'August',
					'September',
					'October',
					'November',
					'December',
				][rec.monid-1]+' '+rec.yearid;
			},
			sortfn: undefined
		};


		function collectDim(dim) {
			var groups = {};
			for(var i=0, ilen = cube.recs.length; i<ilen;i++) {
				var rec = cube.recs[i];
				var group = groups[dim.addressfn(rec)];
				if(!group) {
					group = groups[dim.addressfn(rec)] = {
						itemad: dim.addressfn(rec), 
						itemname: dim.namefn(rec)
					};
					dim.fldids.forEach(function(key){
						group[key] = rec[key];
					});
				};
			}; 
			dim.xrecs = groups;
			dim.recs = Object.keys(dim.xrecs).map(function(key){return dim.xrecs[key]}).sort(dim.sortfn);
		}

		collectDim(clientDim);
		collectDim(productDim);
		collectDim(yearMonDim);

		// console.table(clientDim.recs);
		// console.table(productDim.recs);
		// console.table(yearMonDim.recs);


		// STEP 3
		// Construction of cube

		var measures = [{id:'amt', name: 'Amount'},{id:'qty', name: 'Quantity'}];


		var s = '<table>';
		s += '<tr>';
		for(var j=0;j<3;j++) {
			s += '<tr>';

			if(j==0) s += '<th>'+'Client'+'</th>';
			else if(j==1) s += '<th>'+''+'</th>';
			else if(j==2) s += '<th>'+''+'</th>';


			productDim.recs.forEach(function(product){
				yearMonDim.recs.forEach(function(yearmon){
					measures.forEach(function(measure){
						s+= '<th>';
						if(j==0) s += productDim.namefn(product);
						else if(j==1) s += yearMonDim.namefn(yearmon);
						else if(j==2) s += measure.name;
						s+= '</th>';
					});
				});
			});
			s += '</tr>';
		};

		clientDim.recs.forEach(function(client){
			s += '<tr>';
			s += '<th>'+clientDim.namefn(client)+'</th>';
			productDim.recs.forEach(function(product){
				yearMonDim.recs.forEach(function(yearmon){
					measures.forEach(function(measure){
						var addr = [
							clientDim.addressfn(client),
							productDim.addressfn(product),
							yearMonDim.addressfn(yearmon)
						].join('`');
						s += '<td>';
						if(typeof cube.xrecs[addr] != 'undefined') {
							s += cube.xrecs[addr][measure.id];
						} else {
							s += ' ';
						};
						s += '</td>';
					});
				});
			});
		});



//		console.table(res);
//		var s= 'ok';
		document.getElementById('result').innerHTML = s;
	</script>
</body>